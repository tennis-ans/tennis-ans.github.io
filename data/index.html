<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TANS Match Data Repository</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../static/style.css">
</head>
<body>
<div class="container">
  <a href="../" class="back-link">‚Üê Back to TANS Home</a>

  <div class="header">
    <h1>Match Data Repository</h1>
    <p class="subtitle">Charted tennis matches in TANS format</p>
  </div>

  <div class="matches-container">
    <ul class="matches-list"></ul>

    <div class="stats">
      <h3>üìà Repository Statistics</h3>
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-number" id="totalFiles">0</span><span class="stat-label">Matches</span></div>
        <div class="stat-item"><span class="stat-number" id="totalYears">0</span><span class="stat-label">Years</span></div>
        <div class="stat-item"><span class="stat-number" id="latestYear">N/A</span><span class="stat-label">Latest</span></div>
      </div>
    </div>
  </div>
</div>

<div class="upload-section">
  <h3>Upload Charted Match Data (.txt)</h3>
  <label for="fileInput" style="display:block; margin-bottom:18px; cursor:pointer;">
    <span style="display:inline-block; background:#e8f5e8; color:#2E7D32; border-radius:8px; padding:12px 24px; font-weight:500; font-size:1em; box-shadow:0 2px 8px rgba(76,175,80,0.08);">Choose File</span>
    <input type="file" id="fileInput" accept=".txt" style="display:none;">
  </label>
  <button onclick="uploadFile()">Upload to Repository</button>
  <div id="selectedFileName" style="margin-bottom:10px; color:#333; font-size:0.98em; font-weight:500;"></div>
  <div id="uploadStatus" style="margin-top:10px; color:#2E7D32; font-weight:600; font-size:1em;"></div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const selectedFileName = document.getElementById('selectedFileName');
const list = document.querySelector('.matches-list');
const stats = {
  totalFiles: document.getElementById('totalFiles'),
  totalYears: document.getElementById('totalYears'),
  latestYear: document.getElementById('latestYear')
};

fileInput.addEventListener('change', () => {
  selectedFileName.innerText = fileInput.files.length ? `Selected: ${fileInput.files[0].name}` : '';
});

function loadFiles() {
  fetch('/files')
    .then(res => res.json())
    .then(async files => {
      list.innerHTML = '';
      const years = new Set();
      let latest = 0;

      for (const file of files) {
        const url = file.file_url || file.url;
        let eventName = file.name;
        let videoUrl = null;

        // Fetch the text content of the file to parse Event & Video Url
        try {
          const txtRes = await fetch(url);
          const txt = await txtRes.text();
          const eventMatch = txt.match(/\[Event:\s*(.*?)\]/i);
          const videoMatch = txt.match(/\[Video Url:\s*(.*?)\]/i);
          if (eventMatch) eventName = eventMatch[1];
          if (videoMatch) videoUrl = videoMatch[1];
        } catch (e) {
          console.warn('Failed to fetch file for parsing:', file.name);
        }

        const li = document.createElement('li');
        li.className = 'match-item';
        li.innerHTML = `
          <div class="match-info">
            <a href="${url}" class="match-title" target="_blank">${eventName}</a>
            <div class="match-meta">
              <span class="match-year">${file.year}</span>
            </div>
          </div>
          <div class="match-actions">
            <a href="${url}" class="data-link" target="_blank">üìÑ View Data</a>
            ${videoUrl ? `<a href="${videoUrl}" class="data-video" target="_blank">üé• Watch Video</a>` : ''}
          </div>`;
        list.appendChild(li);

        if (file.year && !isNaN(file.year)) { 
          years.add(file.year); 
          latest = Math.max(latest, parseInt(file.year)); 
        }
      }

      stats.totalFiles.innerText = files.length;
      stats.totalYears.innerText = years.size;
      stats.latestYear.innerText = latest || 'N/A';
    })
    .catch(err => console.error('Error loading files:', err));
}

function uploadFile() {
  const status = document.getElementById('uploadStatus');
  if (!fileInput.files.length) { status.innerText = 'Please select a .txt file.'; return; }
  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  status.innerText = 'Uploading...';
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      if (data.file_url) { 
        status.innerText = 'Upload successful!'; 
        loadFiles(); 
      } else { 
        status.innerText = data.error || 'Unknown error'; 
      }
    })
    .catch(() => { status.innerText = 'Upload failed!'; });
}

document.addEventListener('DOMContentLoaded', loadFiles);
</script>
</body>
</html>
