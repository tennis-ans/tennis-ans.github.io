<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TANS Match Data Repository</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../static/style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <a href="../" class="back-link">‚Üê Back to TANS Home</a>

  <div class="header">
    <h1>Match Data Repository</h1>
    <p class="subtitle">Charted tennis matches in TANS format</p>
  </div>

  <div class="matches-container">
    <ul class="matches-list"></ul>

    <div class="stats">
      <h3>üìà Repository Statistics</h3>
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-number" id="totalFiles">0</span><span class="stat-label">Matches</span></div>
        <div class="stat-item"><span class="stat-number" id="totalYears">0</span><span class="stat-label">Years</span></div>
        <div class="stat-item"><span class="stat-number" id="latestYear">N/A</span><span class="stat-label">Latest</span></div>
      </div>
    </div>
  </div>
</div>

<div class="upload-section">
  <h3>Upload Charted Match Data (.txt)</h3>
  <label for="fileInput" style="display:block; margin-bottom:18px; cursor:pointer;">
    <span style="display:inline-block; background:#e8f5e8; color:#2E7D32; border-radius:8px; padding:12px 24px; font-weight:500; font-size:1em; box-shadow:0 2px 8px rgba(76,175,80,0.08);">Choose File</span>
    <input type="file" id="fileInput" accept=".txt" style="display:none;">
  </label>
  <button onclick="uploadFile()">Upload to Repository</button>
  <div id="selectedFileName" style="margin-bottom:10px; color:#333; font-size:0.98em; font-weight:500;"></div>
  <div id="uploadStatus" style="margin-top:10px; color:#2E7D32; font-weight:600; font-size:1em;"></div>
</div>

<script>
const { createClient } = supabase;
const supabaseUrl = "https://vspbkgtxkjnayyivmeqy.supabase.co"; 
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzcGJrZ3R4a2puYXl5aXZtZXF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNjY4MDksImV4cCI6MjA3MzY0MjgwOX0.r6_lgnvnC6v_7yfEJ9fPOPvr_CM6GPync2OWENnoqQ0";
const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

const bucketName = "charted_data";

const fileInput = document.getElementById('fileInput');
const selectedFileName = document.getElementById('selectedFileName');
const list = document.querySelector('.matches-list');
const stats = {
  totalFiles: document.getElementById('totalFiles'),
  totalYears: document.getElementById('totalYears'),
  latestYear: document.getElementById('latestYear')
};

fileInput.addEventListener('change', () => {
  selectedFileName.innerText = fileInput.files.length ? `Selected: ${fileInput.files[0].name}` : '';
});

async function loadFiles() {
  const { data, error } = await supabaseClient.storage.from(bucketName).list("uploads", { limit: 100 });
  if (error) {
    console.error("Error loading files:", error);
    return;
  }

  list.innerHTML = '';
  const years = new Set();
  let latest = 0;

  for (const file of data) {
    const { data: urlData } = supabaseClient.storage.from(bucketName).getPublicUrl(`uploads/${file.name}`);
    const url = urlData.publicUrl;

    let eventName = file.name;
    let videoUrl = null;
    let year = "N/A";

    try {
      const txtRes = await fetch(url);
      const txt = await txtRes.text();
      const eventMatch = txt.match(/\[Event:\s*(.*?)\]/i);
      const videoMatch = txt.match(/\[Video Url:\s*(.*?)\]/i);
      const yearMatch = txt.match(/\[Event:\s*(\d+)/i);
      if (eventMatch) eventName = eventMatch[1];
      if (videoMatch) videoUrl = videoMatch[1];
      if (yearMatch) year = yearMatch[1];
    } catch (e) {
      console.warn("Failed to parse file:", file.name);
    }

    const li = document.createElement('li');
    li.className = 'match-item';
    li.innerHTML = `
      <div class="match-info">
        <a href="${url}" class="match-title" target="_blank">${eventName}</a>
        <div class="match-meta">
          <span class="match-year">${year}</span>
        </div>
      </div>
      <div class="match-actions">
        <a href="${url}" class="data-link" target="_blank">üìÑ View Data</a>
        ${videoUrl ? `<a href="${videoUrl}" class="data-video" target="_blank">üé• Watch Video</a>` : ''}
      </div>`;
    list.appendChild(li);

    if (year && !isNaN(year)) {
      years.add(year);
      latest = Math.max(latest, parseInt(year));
    }
  }

  stats.totalFiles.innerText = data.length;
  stats.totalYears.innerText = years.size;
  stats.latestYear.innerText = latest || 'N/A';
}

async function uploadFile() {
  const status = document.getElementById('uploadStatus');
  
  if (!fileInput.files.length) { 
    status.innerText = 'Please select a .txt file.'; 
    status.style.color = '#d32f2f';
    return; 
  }
  
  const file = fileInput.files[0];
  status.innerText = 'Uploading...';
  status.style.color = '#1976d2';

  try {
    // Generate a unique filename to avoid conflicts
    const fileName = `${file.name}`;
    
    const { data, error } = await supabaseClient
      .storage
      .from(bucketName)
      .upload(`uploads/${fileName}`, file, { 
        upsert: true,
        contentType: 'text/plain'
      });

    if (error) {
      console.error('Upload error:', error);
      status.innerText = `Upload failed: ${error.message}`;
      status.style.color = '#d32f2f';
      
      // Provide specific guidance based on error type
      if (error.message.includes('row-level security')) {
        status.innerText += ' (Check storage bucket permissions)';
      }
    } else {
      status.innerText = 'Upload successful!';
      status.style.color = '#2E7D32';
      
      // Clear the file input and selected file name
      fileInput.value = '';
      selectedFileName.innerText = '';
      
      // Reload the files list
      loadFiles();
    }
  } catch (err) {
    console.error('Unexpected error:', err);
    status.innerText = 'Upload failed due to unexpected error';
    status.style.color = '#d32f2f';
  }
}


document.addEventListener('DOMContentLoaded', loadFiles);
</script>
</body>
</html>
